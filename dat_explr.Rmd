---
title: "Pteropod Puget Sound time series"
author: ""
output: 
  html_document:
    css: kable.css
self_contained: yes
runtime: shiny
---

```{r, message = F, warning = F, echo = F}
library(knitr)
opts_chunk$set(warning = FALSE, message = FALSE, dev.args = list(bg = 'transparent'), eval = T, echo = F)

library(tidyverse)
library(shiny)
library(gridExtra)
library(glue)
library(lubridate)
library(patchwork)
library(shinyWidgets)

data(chmdat)
data(biodat)

# pteropod birthday
strt <- '2008-06-01' %>% 
  as.Date

# make cohortyr an ordered factor
biodat <- biodat %>% 
  mutate(cohortyr = factor(cohortyr, ordered = T))
chmdat <- chmdat %>% 
  mutate(cohortyr = factor(cohortyr, ordered = T))
```

```{r reactives}
# cumulative stress data
strdat <- reactive({

  # inputs
  val <- input$val
  sta <- input$sta
  thrsh <- input$thrsh

  out <- chmdat %>% 
    filter(var %in% 'ara') %>% 
    full_join(biodat, by = c('station', 'date', 'yr', 'cohortyr', 'mo')) %>% 
    select(-lon, -lat, -var, -abu, -avesz, -stdsz, -yr) %>% 
    gather('ara', 'chmval', ave:std) %>% 
    filter(ara %in% val) %>% 
    filter(station %in% sta) %>% 
    mutate(
      aracat = ifelse(chmval < thrsh, 1, 0),
      aradff = pmax(0, thrsh - chmval)
      ) %>% 
    unite('costa', cohortyr, station, remove = F) %>% 
    group_by(costa) %>% 
    mutate(
      strsdis = cumsum(aracat),
      strscnt = cumsum(aradff)
    ) 

  return(out)
  
})
```

```{r}
column(12, 
  column(4, 
    selectInput('chm', 'Select chemistry:', choices = c('ara', 'co3', 'ph', 'pco2', 'temp'))
  ),
  
  column(4, 
    selectInput('val', 'Select chemistry value:', choices = c('min', 'ave', 'max', 'std'))
  ),
  
  column(4, 
    selectInput('dis', 'Select dissolution:', choices = c('typ1', 'typ2', 'typ3'), selected = 'typ3')
  )
)
column(12, 
  column(4, 
  
    pickerInput(inputId = "sta", label = 'Select stations:', choices = unique(chmdat$station),
      options = list(`actions-box` = TRUE, size = 20), selected = unique(chmdat$station), multiple = TRUE)    
              
  )       
)
```

Year values shown correspond to "cohort-years" that begin in June with spring spawning, i.e., the April "cohort-year" is one year prior to the calendar year.  

## {.tabset}

### Grouped by year

The first set of plots show the selected pteropod response measure against the selected environmental measure observed at the time of sampling.  Plots are facetted by cohort-year with points in each facet colored by month. 
```{r}
renderPlot({
  
  # inputs
  chm <- input$chm
  dis <- input$dis
  val <- input$val
  sta <- input$sta
  
  
  dat <- chmdat %>% 
    filter(var %in% chm) %>% 
    full_join(biodat, by = c('station', 'date', 'yr', 'cohortyr', 'mo')) %>% 
    select(-lon, -lat, -var, -abu, -avesz, -stdsz) %>% 
    gather('dissvar', 'dissval', typ1:typ3) %>% 
    gather('chemvar', 'chemval', ave:std) %>% 
    filter(dissvar %in% dis) %>% 
    filter(chemvar %in% val) %>% 
    filter(station %in% sta)

  p <- ggplot(dat, aes(x = chemval, y = dissval)) +
    # geom_line(aes(group = station), colour = 'grey') +
    stat_smooth(method = 'lm', se = F, colour = 'black') +
    geom_point(aes(fill = mo, group = station), pch = 21, size = 4) +
    facet_grid(~ cohortyr) + #, scales = 'free') +
    ylab(dis) +
    xlab(paste(val, chm)) +
    theme_bw(base_family = 'serif', base_size = 16) +
    theme(
      strip.background = element_blank(), 
      legend.title = element_blank(), 
      legend.position = 'top'
    )

  return(p)
  
}, height = 300, width = 850)

```

The second set of plots show the selected environmental measure against temperature with points sized by the pteropod response measure. The x-axis is alway temperature and can be selected to show minimum, average, and maximum. Plots are facetted by cohort-year with points in each facet colored by month. 
```{r}
column(12, 
  column(4, 
    selectInput('tmp', 'Select x-axis temperature value:', choices = c('min', 'ave', 'max', 'std'))
  )
)

renderPlot({
  
  # inputs
  chm <- input$chm
  dis <- input$dis
  val <- input$val
  tmp <- input$tmp
  sta <- input$sta

  dat <- chmdat %>% 
    filter(var %in% c(chm, 'temp')) %>% 
    full_join(biodat, by = c('station', 'date', 'yr', 'cohortyr', 'mo')) %>% 
    select(-lon, -lat, -abu, -avesz, -stdsz) %>% 
    gather('dissvar', 'dissval', typ1:typ3) %>% 
    gather('chemvar', 'chemval', ave:std) %>% 
    filter(dissvar %in% dis) %>% 
    filter(var %in% chm & chemvar %in% val | var %in% 'temp' & chemvar %in% tmp) %>%
    filter(station %in% sta) %>% 
    select(-chemvar) %>% 
    spread(var, chemval)

  p <- ggplot(dat, aes_string(x = 'temp', y = chm, size = 'dissval')) +
    geom_point(aes(fill = mo, group = station), pch = 21) +
    stat_smooth(method = 'lm', se = F, colour = 'black') +
    facet_grid(~ cohortyr) +
    ylab(paste(val, chm)) +
    xlab(paste(tmp, 'temp')) +
    scale_size(dis, range = c(2, 10)) +
    theme_bw(base_family = 'serif', base_size = 16) +
    theme(
      strip.background = element_blank(), 
      # legend.title = element_blank(), 
      legend.position = 'top'
    ) + 
    guides(
      fill = guide_legend('', override.aes = list(size = 4)),
      size = guide_legend(override.aes = list(linetype = 0))
      )

  return(p)
  
}, height = 315, width = 850)

```

### Grouped by season

The first set of plots show the selected pteropod response measure against the selected environmental measure observed at the time of sampling.  Plots are facetted by cohort-year with points in each facet colored by cohort year. 
```{r}
renderPlot({
  
  # inputs
  chm <- input$chm
  dis <- input$dis
  val <- input$val
  sta <- input$sta
  
  dat <- chmdat %>% 
    filter(var %in% chm) %>% 
    full_join(biodat, by = c('station', 'date', 'yr', 'cohortyr', 'mo')) %>% 
    select(-lon, -lat, -var, -abu, -avesz, -stdsz) %>% 
    gather('dissvar', 'dissval', typ1:typ3) %>% 
    gather('chemvar', 'chemval', ave:std) %>% 
    filter(dissvar %in% dis) %>% 
    filter(chemvar %in% val) %>%
    filter(station %in% sta) 

  p <- ggplot(dat, aes(x = chemval, y = dissval)) +
    # geom_line(aes(group = station), colour = 'grey') +
    stat_smooth(method = 'lm', se = F, colour = 'black') +
    geom_point(aes(fill = factor(cohortyr), group = station), pch = 21, size = 4) +
    facet_grid(~ mo) + #, scales = 'free') +
    ylab(dis) +
    xlab(paste(val, chm)) +
    theme_bw(base_family = 'serif', base_size = 16) +
    theme(
      strip.background = element_blank(), 
      legend.title = element_blank(), 
      legend.position = 'top'
    )

  return(p)
  
}, height = 300, width = 850)

```

The second set of plots show the selected environmental measure against temperature with points sized by the pteropod response measure. The x-axis is alway temperature and can be selected to show minimum, average, and maximum. Plots are facetted by cohort-year with points in each facet colored by cohort year. 
```{r}
column(12, 
  column(4, 
    selectInput('tmp2', 'Select x-axis temperature value:', choices = c('min', 'ave', 'max', 'std'))
  )
)

renderPlot({
  
  # inputs
  chm <- input$chm
  dis <- input$dis
  val <- input$val
  sta <- input$sta
  tmp2 <- input$tmp2
  
  dat <- chmdat %>% 
    filter(var %in% c(chm, 'temp')) %>% 
    full_join(biodat, by = c('station', 'date', 'yr', 'cohortyr', 'mo')) %>% 
    select(-lon, -lat, -abu, -avesz, -stdsz) %>% 
    gather('dissvar', 'dissval', typ1:typ3) %>% 
    gather('chemvar', 'chemval', ave:std) %>% 
    filter(dissvar %in% dis) %>% 
    filter(station %in% sta) %>% 
    filter(var %in% chm & chemvar %in% val | var %in% 'temp' & chemvar %in% tmp2) %>% 
    select(-chemvar) %>% 
    spread(var, chemval)

  p <- ggplot(dat, aes_string(x = 'temp', y = chm, size = 'dissval')) +
    geom_point(aes(fill = factor(cohortyr), group = station), pch = 21) +
    stat_smooth(method = 'lm', se = F, colour = 'black') +
    facet_grid(~ mo) +
    ylab(paste(val, chm)) +
    xlab(paste(tmp2, 'temp')) +
    scale_size(dis, range = c(2, 10)) +
    theme_bw(base_family = 'serif', base_size = 16) +
    theme(
      strip.background = element_blank(), 
      # legend.title = element_blank(), 
      legend.position = 'top'
    ) + 
    guides(
      fill = guide_legend('', override.aes = list(size = 4)),
      size = guide_legend(override.aes = list(linetype = 0))
      )

  return(p)
  
}, height = 315, width = 850)

```

### By station and cumulative stress {.tabset .tabset-pills}

```{r}
column(12, 
       
       column(4, numericInput('thrsh', 'Under-saturation threshold:', value = 1, min = 0, max = 5, step = 0.05))
       
       )
```

#### By station

These plots show the selected pteropod response measure and selected environmental measure collected over time with facets for each station.  Points are joined within cohort-years and colored by month. The red line in the right plot shows a saturation state equal to `r renderText({input$thrsh})` when aragonite is selected.

```{r}
renderPlot({
  
  # input 
  dis <- input$dis
  chm <- input$chm
  val <- input$val
  sta <- input$sta
  thrsh <- input$thrsh
  strdat <- strdat()
  
  # bio
  toplo1 <- biodat %>% 
    select(date, yr, cohortyr, mo, station, typ1, typ2, typ3) %>% 
    gather('diss', 'val', typ1:typ3) %>% 
    filter(diss %in% dis) %>% 
    filter(station %in% sta)
  
  p1 <- ggplot(toplo1, aes(x = factor(date), y = val)) +
    geom_line(aes(group = cohortyr)) +
    geom_point(aes(fill = mo), alpha = 0.7, size = 4, pch = 21) +
    facet_grid(station~.) +
    theme_bw(base_family = 'serif', base_size = 14) +
    theme(
      strip.background = element_blank(), 
      axis.title.x = element_blank(), 
      legend.title = element_blank(),
      axis.text.x  = element_text(size = 10, angle = 45, hjust = 1),
      # panel.grid = element_blank(), 
      legend.position = 'top'
      ) +
    ylab(dis) + 
    scale_x_discrete(labels = format(unique(toplo1$date), '%Y-%m'))
  
  # chem
  toplo2 <- chmdat %>% 
    filter(var %in% chm) %>% 
    gather('estv', 'valv', ave:std) %>% 
    filter(estv %in% val) %>% 
    filter(station %in% sta)
  
  p2 <- ggplot(toplo2, aes(x = factor(date), y = valv)) +
    geom_line(aes(group = cohortyr)) +
    geom_point(aes(fill = mo), alpha = 0.7, size  = 4, pch = 21) +
    facet_grid(station~.) +
    theme_bw(base_family = 'serif', base_size = 14) + 
    theme(
      strip.background = element_blank(), 
      axis.title.x = element_blank(), 
      legend.title = element_blank(),
      axis.text.x  = element_text(size = 10, angle = 45, hjust = 1),
      # panel.grid = element_blank(), 
      legend.position = 'top'
      ) +
    ylab(chm) + 
    scale_x_discrete(labels = format(unique(toplo2$date), '%Y-%m'))

  # add 1 horizontal or aragonite
  if(chm == 'ara')
    p2 <- p2 + 
      geom_hline(yintercept = thrsh, colour = 'tomato1', size = 1, alpha = 0.7) +
      geom_text(data = strdat, aes(y = thrsh, label = paste(strsdis, round(strscnt, 1), sep = ', ')), colour = 'tomato1', vjust = 1, hjust = 0)
  
  grid.arrange(p1, p2, ncol = 2)
  
}, height = 900, width = 900)
```

#### Evaluating cumulative stress, discrete

Within each cohort year, the "cumulative stress" was estimated as the duration of time within a cohort year when under-saturation of aragonite occcurred.  For "discrete stress", the number of times a sampling period was under-saturated was counted for all of the sampling months in a cohort-year.  This produced an estimate of total stress within a cohort-year as the cumulative measure from zero to three, where zero meant that none of the sampling periods were under-saturated and three meant all were under-saturated.  The cumulative stress counts assigned to each station and cohort year can be viewed in the first tab.

```{r}

renderPlot({
  
  # input
  strdat <- strdat()
  dis <- input$dis

  # rename pteropod response measure to generic
  toplo <- strdat %>% 
    rename(
      rsp = !!dis
    )
  
  p1 <- ggplot(toplo, aes(x = strsdis, y = rsp)) +
    geom_line(aes(group = costa)) +
    geom_point(aes(fill = mo, group = costa), pch = 21, size = 4) +
    geom_smooth(method = 'lm', colour = 'black') +
    xlab('Cumulative stress magnitude') +
    ylab(dis) +
    facet_wrap(~cohortyr) +
    theme_bw(base_family = 'serif', base_size = 16) + 
    theme(
      legend.position = 'top', 
      legend.title = element_blank()
    )
  
  p2 <- ggplot(toplo, aes(x = mo, y = strsdis, group = costa)) +
    geom_line() +
    geom_jitter(aes(fill = mo, size = rsp), pch = 21, width = 0.1, height = 0.1) +
    ylab('Cumulative stress magnitude') +
    facet_wrap(~cohortyr) +
    theme_bw(base_family = 'serif', base_size = 16) + 
    theme(
      axis.title.x = element_blank(), 
      legend.position = 'top'
    ) + 
    scale_size(dis) +
    guides(fill = guide_legend(title = element_blank(), override.aes = list(size = 4)))
  
  p1 + p2 + plot_layout(ncol = 1, heights = c(1, 1))

}, height = 600, width = 850)
  
```

#### Evaluating cumulative stress, continuous

Within each cohort year, the "cumulative stress" was estimated as the duration of time within a cohort year when under-saturation of aragonite occcurred.  For "continuous stress", the difference between measured aragonite saturation and the selected under-saturation was used as measure of cumulative stress in a cohort-year.  This produced an estimate of total stress within a cohort-year as the total sum of the difference.  The cumulative stress counts assigned to each station and cohort year can be viewed in the first tab.

```{r}
renderPlot({
  
  # input
  strdat <- strdat()
  dis <- input$dis

  # rename pteropod response measure to generic
  toplo <- strdat %>% 
    rename(
      rsp = !!dis
    )
  
  p1 <- ggplot(toplo, aes(x = strscnt, y = rsp)) +
    geom_line(aes(group = costa)) +
    geom_point(aes(fill = mo, gruop = costa), pch = 21, size = 4) +
    geom_smooth(method = 'lm', colour = 'black') +
    xlab('Cumulative stress magnitude') +
    ylab(dis) +
    facet_wrap(~cohortyr) +
    theme_bw(base_family = 'serif', base_size = 16) + 
    theme(
      legend.position = 'top', 
      legend.title = element_blank()
    )
  
  p2 <- ggplot(toplo, aes(x = mo, y = strscnt, group = costa)) +
    geom_line() +
    geom_jitter(aes(fill = mo, size = rsp), pch = 21, width = 0.1, height = 0.1) +
    ylab('Cumulative stress magnitude') +
    facet_wrap(~cohortyr) +
    theme_bw(base_family = 'serif', base_size = 16) + 
    theme(
      axis.title.x = element_blank(), 
      legend.position = 'top'
    ) + 
    scale_size(dis) +
    guides(fill = guide_legend(title = element_blank(), override.aes = list(size = 4)))
  
  p1 + p2 + plot_layout(ncol = 1, heights = c(1, 1))

}, height = 600, width = 850)
  
```