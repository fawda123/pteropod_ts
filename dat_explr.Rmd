---
title: "Pteropod Puget Sound time series"
author: ""
output: 
  html_document:
    css: kable.css
self_contained: yes
runtime: shiny
---

```{r, message = F, warning = F, echo = F}
library(knitr)
opts_chunk$set(warning = FALSE, message = FALSE, dev.args = list(bg = 'transparent'), eval = T, echo = F)

library(tidyverse)
library(shiny)
library(gridExtra)
library(glue)
library(lubridate)

data(chmdat)
data(biodat)
data(simdat)

# pteropod birthday
strt <- '2008-06-01' %>% 
  as.Date

# add cumulative day counter to simdat
# starts from bday, then arrange by counter
simdat <- simdat %>% 
  group_by(station) %>% 
  arrange(station, datetime) %>% 
  mutate( # setup index
    dys =  6 / 24, 
    dys = cumsum(dys),
    crr = dys[datetime == strt],
    dys = case_when(
      datetime >= strt ~ dys - crr,
      datetime < strt ~ dys + max(dys) - crr
    )
  ) %>%
  arrange(station, dys) %>% 
  select(-crr)

# aggregated biological data to match with sim data
# 2014 and 2015 averaged by month
biodatagg <- biodat %>% 
  filter(cohortyr %in% c(2014, 2015)) %>% 
  select(station, mo, typ1, typ2, typ3) %>% 
  gather('var', 'val', -station, -mo) %>% 
  group_by(station, mo, var) %>% 
  summarise(val = mean(val, na.rm = T)) %>% 
  spread(var, val) %>% 
  ungroup %>% 
  mutate(
    datetime = paste('2008', as.numeric(mo), '15 00:00', sep = '-'),
    datetime = as.POSIXct(datetime, tz = 'UTC'),
    mo = factor(mo, levels = c('Jul', 'Sep', 'Apr')), 
    station = as.character(station)
  ) 
```

```{r}
column(12, 
  column(4, 
    selectInput('chm', 'Select chemistry:', choices = c('ara', 'co3', 'ph', 'pco2'))
  ),
  
  column(4, 
    selectInput('val', 'Select chemistry value:', choices = c('min', 'ave', 'max'))
  ),
  
  column(4, 
    selectInput('dis', 'Select dissolution:', choices = c('typ1', 'typ2', 'typ3'))
  )
)
```

Year values shown correspond to "cohort-years" that begin in June with spring spawning, i.e., the April "cohort-year" is one year prior to the calendar year.  

```{r}
renderPlot({
  
  # inputs
  chm <- input$chm
  dis <- input$dis
  val <- input$val
  
  dat <- chmdat %>% 
    filter(var %in% chm) %>% 
    full_join(biodat, by = c('station', 'date', 'yr', 'cohortyr', 'mo')) %>% 
    select(-lon, -lat, -var, -abu, -avesz, -stdsz) %>% 
    gather('dissvar', 'dissval', typ1:typ3) %>% 
    gather('chemvar', 'chemval', ave:max) %>% 
    filter(dissvar %in% dis) %>% 
    filter(chemvar %in% val)

  p <- ggplot(dat, aes(x = chemval, y = dissval)) +
    # geom_line(aes(group = station), colour = 'grey') +
    stat_smooth(method = 'lm', se = F, colour = 'black') +
    geom_point(aes(fill = mo, group = station), pch = 21, size = 4) +
    facet_grid(~ cohortyr, scales = 'free') +
    ylab(dis) +
    xlab(chm) +
    theme_bw(base_family = 'serif', base_size = 16) +
    theme(
      strip.background = element_blank(), 
      legend.title = element_blank(), 
      legend.position = 'top'
    )

  return(p)
  
}, height = 300, width = 850)

```

```{r}
renderPlot({
  
  # input 
  dis <- input$dis
  chm <- input$chm
  val <- input$val
  
  # bio
  toplo1 <- biodat %>% 
    select(date, yr, cohortyr, mo, station, typ1, typ2, typ3) %>% 
    gather('diss', 'val', typ1:typ3) %>% 
    filter(diss %in% dis)
  
  p1 <- ggplot(toplo1, aes(x = factor(date), y = val)) +
    geom_line(aes(group = cohortyr)) +
    geom_point(aes(fill = mo), alpha = 0.7, size = 4, pch = 21) +
    facet_grid(station~.) +
    theme_bw(base_family = 'serif', base_size = 14) +
    theme(
      strip.background = element_blank(), 
      axis.title.x = element_blank(), 
      legend.title = element_blank(),
      axis.text.x  = element_text(size = 10, angle = 45, hjust = 1),
      # panel.grid = element_blank(), 
      legend.position = 'top'
      ) +
    ylab(dis) + 
    scale_x_discrete(labels = format(unique(toplo1$date), '%Y-%m'))
  
  # chem
  toplo2 <- chmdat %>% 
    filter(var %in% chm) %>% 
    gather('estv', 'valv', ave:max) %>% 
    filter(estv %in% val)
  
  p2 <- ggplot(toplo2, aes(x = factor(date), y = valv)) +
    geom_line(aes(group = cohortyr)) +
    geom_point(aes(fill = mo), alpha = 0.7, size  = 4, pch = 21) +
    facet_grid(station~.) +
    theme_bw(base_family = 'serif', base_size = 14) + 
    theme(
      strip.background = element_blank(), 
      axis.title.x = element_blank(), 
      legend.title = element_blank(),
      axis.text.x  = element_text(size = 10, angle = 45, hjust = 1),
      # panel.grid = element_blank(), 
      legend.position = 'top'
      ) +
    ylab(chm) + 
    scale_x_discrete(labels = format(unique(toplo2$date), '%Y-%m'))

  # add 1 horizontal or aragonite
  if(chm == 'ara')
    p2 <- p2 + 
      geom_hline(yintercept = 1, colour = 'tomato1', size = 1, alpha = 0.7)
  
  grid.arrange(p1, p2, ncol = 2)
  
}, height = 900, width = 900)
```

### Evaluating cumulative stress

Within each cohort year, the "cumulative stress" as the duration of time was estimated at which under-saturation of aragonite occcurred.  This was calculated two ways.  First, the number of times a sampling period was under-saturated was counted for all of the sampling months in a cohort-year.  This produced an estimate of total stress within a cohort-year as a count measure from zero to three, where zero meant that none of the sampling periods were under-saturated and three meant all were under-saturated.  Second, the number of times that July and September sampling events were under-saturated were counted as a measure of prior cumulative stress for the April sampling event.  This produced an estimate of cumulative stress as a count measure varying from zero to two.  For both cases, the amount of type 3 dissolution that was observed in April (i.e., mature adults at the end of a cohort-year) was used as a response to the cumulative stress measure.  

The analysis also considered what was defined as cumulative stress in addition to duration.  In other words, cumulative stress could be measured using the average aragonite saturation in a sampling month at a station, the minimum saturation, or the maximum saturation.  Additionally, what defines over- and under-saturation was also considered.  Typically, values less than one are considered undefr-saturated but this value could be changed as a measure of specificity to which individuals may show differential response.  The results below can be assessed in consideration of the above.  

```{r}
column(12, 
       
       column(4, selectInput('araval', 'Select aragonite value:', choices = c('min', 'ave', 'max'))),
       
       column(4, selectInput('strmsr', 'Select stress measure:', choices = list(total = 'totstr', cumulative = 'cumstr'))),
       
       column(4, numericInput('thrsh', 'Under-saturation threshold:', value = 1, min = 0, max = 5, step = 0.1))
       
       )
```

```{r}
strdat <- reactive({

  # inputs
  araval <- input$araval
  strmsr <- input$strmsr
  thrsh <- input$thrsh

  dat <- chmdat %>% 
    filter(var %in% 'ara') %>% 
    full_join(biodat, by = c('station', 'date', 'yr', 'cohortyr', 'mo')) %>% 
    select(-lon, -lat, -var, -abu, -avesz, -stdsz, -yr) %>% 
    gather('ara', 'val', ave:max) %>% 
    filter(ara %in% araval) %>% 
    mutate(aracat = ifelse(val < thrsh, 'under', 'over')) %>% 
    group_by(cohortyr, station) %>% 
    mutate(
      cumstr = sum(aracat[!mo %in% 'Apr'] %in% 'under'),
      totstr = sum(aracat %in% 'under')
      ) %>% 
    filter(mo %in% 'Apr') %>% 
    select(-aracat)

  names(dat)[names(dat) %in% strmsr] <- 'strsval'
  
  return(dat)
  
})

renderPlot({
  
  # input
  strdat <- strdat()
  
  ggplot(strdat, aes(x = factor(strsval), y = typ3)) +
    geom_boxplot() +
    scale_x_discrete('Cumulative stress magnitude') +
    scale_y_continuous('End of cohort-year (April) type 3') +
    theme_bw(base_family = 'serif', base_size = 18) +
    facet_wrap(~cohortyr, ncol = 2) 

}, height = 400, width = 750)
  
```

### Simulated data

Conditions at each station were simulated for 2008 at six hour time steps for every station.  This time series is considered a representative sample of the seasonal variation in water quality conditions at each site independent of annual variation.  Each time series was used to estimate a cumulative stress measure of the number of days at which aragonite was under-saturated, starting from June 1st as the start of a pteropod cohort year.  This measure of stress was then compared to the amount of dissolution during the three sample months in the biological dataset.  Annual data were averaged by each month for the biological data.  The stress measure can be varied by choosing the threshold for defining under-saturation.  For example, choosing a threshold of one and number of days as one will count the stress as the total number of days at which saturation was below one.  

```{r}
column(12, 
       
       column(4, numericInput('simthrsh', 'Under-saturation threshold:', value = 1, min = 0, max = 5, step = 0.1))
       
)
```

```{r}
# cumulative stress measures from sims
simdatcum <- reactive({

  # input
  simthrsh <- input$simthrsh

  # get cumulative stress measures of days < aragonite thresh
  # aggregated by time
  # from simulated data
  out <- simdat %>% 
    crossing(thrsh = simthrsh) %>% 
    group_by(station, thrsh) %>% 
    arrange(station, thrsh, dys) %>% 
    mutate( # setup cumumulative stress by threshold
      strdys = ifelse(ara < thrsh, 6 / 24, 0),
      strdys = cumsum(strdys)
    )

  return(out)
  
})

# aggregated bio data merged with cumulative stress measures
biodataggmrg <- reactive({
  
  # input
  simdatcum <- simdatcum()
  
  out <- biodatagg %>% 
    left_join(simdatcum, by = c('station', 'datetime'))
  
  return(out)
  
  })
```

```{r}
renderPlot({
  
  # input
  simthrsh <- input$simthrsh
  simdatcum <- simdatcum()
  
  blw <- simdatcum %>% 
    mutate(ara = ifelse(ara <= simthrsh, ara, NA))

  # time series 
  p1 <- ggplot(simdatcum, aes(x = datetime, y = ara)) +
    geom_hline(yintercept = simthrsh, colour = 'grey') +
    geom_point(size = 0.5, colour = 'lightgreen') +
    geom_point(data = blw, colour = 'tomato1', size = 0.5) +
    scale_x_datetime(expand = c(0, 0), date_labels = '%m', date_breaks = '1 month') +
    facet_grid(station~.) +
    theme_bw(base_family = 'serif', base_size = 16) +
    theme(
      strip.background = element_blank(),
      panel.grid = element_blank()
    ) +
    xlab('Calendar year') +
    ylab('Aragonite saturation state')
  
  # cmulative stress days
  p2 <- ggplot(simdatcum, aes(x = dys, y = strdys)) +
    geom_abline(slope = 1, intercept = 0) +
    geom_line(colour = 'tomato1') +
    facet_grid(station~.) +
    theme_bw(base_family = 'serif', base_size = 16) +
    theme(
      strip.background = element_blank(),
      panel.grid = element_blank()
    ) +
    xlab(glue('Days since {month(strt, label = T)} {day(strt)}')) + 
    ylab(glue('Cumulative days with aragonite < {simthrsh}'))
  
  grid.arrange(p1, p2, ncol = 2)
  
}, height = 600)

renderPlot({
  
  # input
  biodataggmrg <- biodataggmrg()
  simthrsh <- input$simthrsh
  
  # dissolution in long format
  toplo <- biodataggmrg %>% 
    gather('var', 'val', typ1:typ3)

  p1 <- ggplot(toplo, aes(x = strdys, y = val)) +
    geom_line(aes(group = station), colour = 'grey') +
    geom_point(aes(fill = mo), pch = 21, size = 4) +
    stat_smooth(method = 'lm', se = F, colour = 'black') +
    facet_grid(~ var, scales = 'free') +
    ylab('Dissolution (%)') +
    xlab(glue('Cumulative days with aragonite < {simthrsh}')) +
    theme_bw(base_family = 'serif', base_size = 16) +
    theme(
      strip.background = element_blank(), 
      legend.title = element_blank(), 
      legend.position = 'top', 
      panel.grid = element_blank()
    )

  return(p1)
  
}, height = 300, width = 850)
```





