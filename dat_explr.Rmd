---
title: "Pteropod Puget Sound time series"
author: ""
output: 
  html_document:
    css: kable.css
self_contained: yes
runtime: shiny
---

```{r, message = F, warning = F, echo = F}
library(knitr)
opts_chunk$set(warning = FALSE, message = FALSE, dev.args = list(bg = 'transparent'), eval = T, echo = F)

library(tidyverse)
library(shiny)
library(gridExtra)
library(glue)
library(lubridate)

data(chmdat)
data(biodat)

# pteropod birthday
strt <- '2008-06-01' %>% 
  as.Date

# aggregated biological data to match with sim data
# 2014 and 2015 averaged by month
biodatagg <- biodat %>% 
  filter(cohortyr %in% c(2014, 2015)) %>% 
  select(station, mo, typ1, typ2, typ3) %>% 
  gather('var', 'val', -station, -mo) %>% 
  group_by(station, mo, var) %>% 
  summarise(val = mean(val, na.rm = T)) %>% 
  spread(var, val) %>% 
  ungroup %>% 
  mutate(
    datetime = paste('2008', as.numeric(mo), '15 00:00', sep = '-'),
    datetime = as.POSIXct(datetime, tz = 'UTC'),
    # mo = factor(mo, levels = c('Jul', 'Sep', 'Apr')), 
    station = as.character(station)
  ) 

# make cohortyr an ordered factor
biodat <- biodat %>% 
  mutate(cohortyr = factor(cohortyr, ordered = T))
chmdat <- chmdat %>% 
  mutate(cohortyr = factor(cohortyr, ordered = T))
```

```{r}
column(12, 
  column(4, 
    selectInput('chm', 'Select chemistry:', choices = c('ara', 'co3', 'ph', 'pco2', 'temp'))
  ),
  
  column(4, 
    selectInput('val', 'Select chemistry value:', choices = c('min', 'ave', 'max'))
  ),
  
  column(4, 
    selectInput('dis', 'Select dissolution:', choices = c('typ1', 'typ2', 'typ3'))
  )
)
```

Year values shown correspond to "cohort-years" that begin in June with spring spawning, i.e., the April "cohort-year" is one year prior to the calendar year.  

## Observed data {.tabset}

### Grouped by year

The first set of plots show the selected pteropod response measure against the selected environmental measure observed at the time of sampling.  Plots are facetted by cohort-year with points in each facet colored by month. 
```{r}
renderPlot({
  
  # inputs
  chm <- input$chm
  dis <- input$dis
  val <- input$val
  
  dat <- chmdat %>% 
    filter(var %in% chm) %>% 
    full_join(biodat, by = c('station', 'date', 'yr', 'cohortyr', 'mo')) %>% 
    select(-lon, -lat, -var, -abu, -avesz, -stdsz) %>% 
    gather('dissvar', 'dissval', typ1:typ3) %>% 
    gather('chemvar', 'chemval', ave:max) %>% 
    filter(dissvar %in% dis) %>% 
    filter(chemvar %in% val)

  p <- ggplot(dat, aes(x = chemval, y = dissval)) +
    # geom_line(aes(group = station), colour = 'grey') +
    stat_smooth(method = 'lm', se = F, colour = 'black') +
    geom_point(aes(fill = mo, group = station), pch = 21, size = 4) +
    facet_grid(~ cohortyr, scales = 'free') +
    ylab(dis) +
    xlab(paste(val, chm)) +
    theme_bw(base_family = 'serif', base_size = 16) +
    theme(
      strip.background = element_blank(), 
      legend.title = element_blank(), 
      legend.position = 'top'
    )

  return(p)
  
}, height = 300, width = 850)

```

The second set of plots show the selected environmental measure against temperature with points sized by the pteropod response measure. The x-axis is alway temperature and can be selected to show minimum, average, and maximum. Plots are facetted by cohort-year with points in each facet colored by month. 
```{r}
column(12, 
  column(4, 
    selectInput('tmp', 'Select x-axis temperature value:', choices = c('min', 'ave', 'max'))
  )
)

renderPlot({
  
  # inputs
  chm <- input$chm
  dis <- input$dis
  val <- input$val
  tmp <- input$tmp

  dat <- chmdat %>% 
    filter(var %in% c(chm, 'temp')) %>% 
    full_join(biodat, by = c('station', 'date', 'yr', 'cohortyr', 'mo')) %>% 
    select(-lon, -lat, -abu, -avesz, -stdsz) %>% 
    gather('dissvar', 'dissval', typ1:typ3) %>% 
    gather('chemvar', 'chemval', ave:max) %>% 
    filter(dissvar %in% dis) %>% 
    filter(var %in% chm & chemvar %in% val | var %in% 'temp' & chemvar %in% tmp) %>% 
    select(-chemvar) %>% 
    spread(var, chemval)

  p <- ggplot(dat, aes_string(x = 'temp', y = chm, size = 'dissval')) +
    geom_point(aes(fill = mo, group = station), pch = 21) +
    stat_smooth(method = 'lm', se = F, colour = 'black') +
    facet_grid(~ cohortyr, scales = 'free') +
    ylab(paste(val, chm)) +
    xlab(paste(tmp, 'temp')) +
    scale_size(dis, range = c(2, 10)) +
    theme_bw(base_family = 'serif', base_size = 16) +
    theme(
      strip.background = element_blank(), 
      # legend.title = element_blank(), 
      legend.position = 'top'
    ) + 
    guides(
      fill = guide_legend('', override.aes = list(size = 4)),
      size = guide_legend(override.aes = list(linetype = 0))
      )

  return(p)
  
}, height = 315, width = 850)

```

### Grouped by season

The first set of plots show the selected pteropod response measure against the selected environmental measure observed at the time of sampling.  Plots are facetted by cohort-year with points in each facet colored by cohort year. 
```{r}
renderPlot({
  
  # inputs
  chm <- input$chm
  dis <- input$dis
  val <- input$val
  
  dat <- chmdat %>% 
    filter(var %in% chm) %>% 
    full_join(biodat, by = c('station', 'date', 'yr', 'cohortyr', 'mo')) %>% 
    select(-lon, -lat, -var, -abu, -avesz, -stdsz) %>% 
    gather('dissvar', 'dissval', typ1:typ3) %>% 
    gather('chemvar', 'chemval', ave:max) %>% 
    filter(dissvar %in% dis) %>% 
    filter(chemvar %in% val)

  p <- ggplot(dat, aes(x = chemval, y = dissval)) +
    # geom_line(aes(group = station), colour = 'grey') +
    stat_smooth(method = 'lm', se = F, colour = 'black') +
    geom_point(aes(fill = factor(cohortyr), group = station), pch = 21, size = 4) +
    facet_grid(~ mo, scales = 'free') +
    ylab(dis) +
    xlab(paste(val, chm)) +
    theme_bw(base_family = 'serif', base_size = 16) +
    theme(
      strip.background = element_blank(), 
      legend.title = element_blank(), 
      legend.position = 'top'
    )

  return(p)
  
}, height = 300, width = 850)

```

The second set of plots show the selected environmental measure against temperature with points sized by the pteropod response measure. The x-axis is alway temperature and can be selected to show minimum, average, and maximum. Plots are facetted by cohort-year with points in each facet colored by cohort year. 
```{r}
column(12, 
  column(4, 
    selectInput('tmp2', 'Select x-axis temperature value:', choices = c('min', 'ave', 'max'))
  )
)

renderPlot({
  
  # inputs
  chm <- input$chm
  dis <- input$dis
  val <- input$val
  tmp2 <- input$tmp2
  
  dat <- chmdat %>% 
    filter(var %in% c(chm, 'temp')) %>% 
    full_join(biodat, by = c('station', 'date', 'yr', 'cohortyr', 'mo')) %>% 
    select(-lon, -lat, -abu, -avesz, -stdsz) %>% 
    gather('dissvar', 'dissval', typ1:typ3) %>% 
    gather('chemvar', 'chemval', ave:max) %>% 
    filter(dissvar %in% dis) %>% 
    filter(var %in% chm & chemvar %in% val | var %in% 'temp' & chemvar %in% tmp2) %>% 
    select(-chemvar) %>% 
    spread(var, chemval)

  p <- ggplot(dat, aes_string(x = 'temp', y = chm, size = 'dissval')) +
    geom_point(aes(fill = factor(cohortyr), group = station), pch = 21) +
    stat_smooth(method = 'lm', se = F, colour = 'black') +
    facet_grid(~ mo, scales = 'free') +
    ylab(paste(val, chm)) +
    xlab(paste(tmp2, 'temp')) +
    scale_size(dis, range = c(2, 10)) +
    theme_bw(base_family = 'serif', base_size = 16) +
    theme(
      strip.background = element_blank(), 
      # legend.title = element_blank(), 
      legend.position = 'top'
    ) + 
    guides(
      fill = guide_legend('', override.aes = list(size = 4)),
      size = guide_legend(override.aes = list(linetype = 0))
      )

  return(p)
  
}, height = 315, width = 850)

```

### Observed data, time series

The third set of plots show the selected pteropod response measure and selected environmental measure collected over time with facets for each station.  Points are joined within cohort-years and colored by month. The red line in the right plot shows a saturation state equal to one when aragonite is selected.
```{r}
renderPlot({
  
  # input 
  dis <- input$dis
  chm <- input$chm
  val <- input$val
  
  # bio
  toplo1 <- biodat %>% 
    select(date, yr, cohortyr, mo, station, typ1, typ2, typ3) %>% 
    gather('diss', 'val', typ1:typ3) %>% 
    filter(diss %in% dis)
  
  p1 <- ggplot(toplo1, aes(x = factor(date), y = val)) +
    geom_line(aes(group = cohortyr)) +
    geom_point(aes(fill = mo), alpha = 0.7, size = 4, pch = 21) +
    facet_grid(station~.) +
    theme_bw(base_family = 'serif', base_size = 14) +
    theme(
      strip.background = element_blank(), 
      axis.title.x = element_blank(), 
      legend.title = element_blank(),
      axis.text.x  = element_text(size = 10, angle = 45, hjust = 1),
      # panel.grid = element_blank(), 
      legend.position = 'top'
      ) +
    ylab(dis) + 
    scale_x_discrete(labels = format(unique(toplo1$date), '%Y-%m'))
  
  # chem
  toplo2 <- chmdat %>% 
    filter(var %in% chm) %>% 
    gather('estv', 'valv', ave:max) %>% 
    filter(estv %in% val)
  
  p2 <- ggplot(toplo2, aes(x = factor(date), y = valv)) +
    geom_line(aes(group = cohortyr)) +
    geom_point(aes(fill = mo), alpha = 0.7, size  = 4, pch = 21) +
    facet_grid(station~.) +
    theme_bw(base_family = 'serif', base_size = 14) + 
    theme(
      strip.background = element_blank(), 
      axis.title.x = element_blank(), 
      legend.title = element_blank(),
      axis.text.x  = element_text(size = 10, angle = 45, hjust = 1),
      # panel.grid = element_blank(), 
      legend.position = 'top'
      ) +
    ylab(chm) + 
    scale_x_discrete(labels = format(unique(toplo2$date), '%Y-%m'))

  # add 1 horizontal or aragonite
  if(chm == 'ara')
    p2 <- p2 + 
      geom_hline(yintercept = 1, colour = 'tomato1', size = 1, alpha = 0.7)
  
  grid.arrange(p1, p2, ncol = 2)
  
}, height = 900, width = 900)
```

## Evaluating cumulative stress

Within each cohort year, the "cumulative stress" as the duration of time was estimated at which under-saturation of aragonite occcurred.  This was calculated two ways.  First, the number of times a sampling period was under-saturated was counted for all of the sampling months in a cohort-year.  This produced an estimate of total stress within a cohort-year as a count measure from zero to three, where zero meant that none of the sampling periods were under-saturated and three meant all were under-saturated.  Second, the number of times that July and September sampling events were under-saturated were counted as a measure of prior cumulative stress for the April sampling event.  This produced an estimate of cumulative stress as a count measure varying from zero to two.  For both cases, the amount of type 3 dissolution that was observed in April (i.e., mature adults at the end of a cohort-year) was used as a response to the cumulative stress measure.  

The analysis also considered what was defined as cumulative stress in addition to duration.  In other words, cumulative stress could be measured using the average aragonite saturation in a sampling month at a station, the minimum saturation, or the maximum saturation.  Additionally, what defines over- and under-saturation was also considered.  Typically, values less than one are considered undefr-saturated but this value could be changed as a measure of specificity to which individuals may show differential response.  The results below can be assessed in consideration of the above.  

```{r}
column(12, 
       
       column(4, selectInput('araval', 'Select aragonite value:', choices = c('min', 'ave', 'max'))),
       
       column(4, selectInput('strmsr', 'Select stress measure:', choices = list(total = 'totstr', cumulative = 'cumstr'))),
       
       column(4, numericInput('thrsh', 'Under-saturation threshold:', value = 1, min = 0, max = 5, step = 0.1))
       
       )
```

```{r}
strdat <- reactive({

  # inputs
  araval <- input$araval
  strmsr <- input$strmsr
  thrsh <- input$thrsh

  dat <- chmdat %>% 
    filter(var %in% 'ara') %>% 
    full_join(biodat, by = c('station', 'date', 'yr', 'cohortyr', 'mo')) %>% 
    select(-lon, -lat, -var, -abu, -avesz, -stdsz, -yr) %>% 
    gather('ara', 'val', ave:max) %>% 
    filter(ara %in% araval) %>% 
    mutate(aracat = ifelse(val < thrsh, 'under', 'over')) %>% 
    group_by(cohortyr, station) %>% 
    mutate(
      cumstr = sum(aracat[!mo %in% 'Apr'] %in% 'under'),
      totstr = sum(aracat %in% 'under')
      ) %>% 
    filter(mo %in% 'Apr') %>% 
    select(-aracat)

  names(dat)[names(dat) %in% strmsr] <- 'strsval'
  
  return(dat)
  
})

renderPlot({
  
  # input
  strdat <- strdat()
  
  ggplot(strdat, aes(x = factor(strsval), y = typ3)) +
    geom_boxplot() +
    scale_x_discrete('Cumulative stress magnitude') +
    scale_y_continuous('End of cohort-year (April) type 3') +
    theme_bw(base_family = 'serif', base_size = 18) +
    facet_wrap(~cohortyr, ncol = 2) 

}, height = 400, width = 750)
  
```