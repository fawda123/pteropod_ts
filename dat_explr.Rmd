---
title: "Pteropod Puget Sound time series"
author: ""
output: 
  html_document:
    code_folding: hide
    css: kable.css
self_contained: yes
runtime: shiny
---

```{r, message = F, warning = F}
library(knitr)
opts_chunk$set(warning = FALSE, message = FALSE, dev.args = list(bg = 'transparent'), eval = T)

library(tidyverse)
library(shiny)
library(gridExtra)
library(glue)

data(chmdat)
data(biodat)
data(simdat)
```

```{r}
column(12, 
  column(4, 
    selectInput('chm', 'Select chemistry:', choices = c('ara', 'co3', 'ph', 'pco2'))
  ),
  
  column(4, 
    selectInput('val', 'Select chemistry value:', choices = c('min', 'ave', 'max'))
  ),
  
  column(4, 
    selectInput('dis', 'Select dissolution:', choices = c('typ1', 'typ2', 'typ3'))
  )
)
```

Year values shown correspond to "cohort-years" that begin in June with spring spawning, i.e., the April "cohort-year" is one year prior to the calendar year.  

```{r}
renderPlot({
  
  # inputs
  chm <- input$chm
  dis <- input$dis
  val <- input$val
  
  dat <- chmdat %>% 
    filter(var %in% chm) %>% 
    full_join(biodat, by = c('station', 'date', 'yr', 'cohortyr', 'mo')) %>% 
    select(-lon, -lat, -var, -abu, -avesz, -stdsz) %>% 
    gather('dissvar', 'dissval', typ1:typ3) %>% 
    gather('chemvar', 'chemval', ave:max) %>% 
    filter(dissvar %in% dis) %>% 
    filter(chemvar %in% val)

  p <- ggplot(dat, aes(x = chemval, y = dissval)) +
    # geom_path(aes(group = station)) +
    stat_smooth(method = 'lm', se = F, colour = 'black') +
    geom_point(aes(fill = mo), pch = 21, size = 4) +
    facet_grid(~ cohortyr, scales = 'free') +
    ylab(dis) +
    xlab(chm) +
    theme_bw(base_family = 'serif', base_size = 16) +
    theme(
      strip.background = element_blank(), 
      legend.title = element_blank(), 
      legend.position = 'top'
    )

  return(p)
  
}, height = 300, width = 850)

```

```{r}
renderPlot({
  
  # input 
  dis <- input$dis
  chm <- input$chm
  val <- input$val
  
  # bio
  toplo1 <- biodat %>% 
    select(date, yr, cohortyr, mo, station, typ1, typ2, typ3) %>% 
    gather('diss', 'val', typ1:typ3) %>% 
    filter(diss %in% dis)
  
  p1 <- ggplot(toplo1, aes(x = factor(date), y = val)) +
    geom_line(aes(group = cohortyr)) +
    geom_point(aes(fill = mo), alpha = 0.7, size = 4, pch = 21) +
    facet_grid(station~.) +
    theme_bw(base_family = 'serif', base_size = 12) +
    theme(
      strip.background = element_blank(), 
      axis.title.x = element_blank(), 
      legend.title = element_blank(),
      axis.text.x  = element_text(size = 10, angle = 45, hjust = 1),
      # panel.grid = element_blank(), 
      legend.position = 'top'
      ) +
    ylab(dis) + 
    scale_x_discrete(labels = format(unique(toplo1$date), '%Y-%m'))
  
  # chem
  toplo2 <- chmdat %>% 
    filter(var %in% chm) %>% 
    gather('estv', 'valv', ave:max) %>% 
    filter(estv %in% val)
  
  p2 <- ggplot(toplo2, aes(x = factor(date), y = valv)) +
    geom_line(aes(group = cohortyr)) +
    geom_point(aes(fill = mo), alpha = 0.7, size  = 4, pch = 21) +
    facet_grid(station~.) +
    theme_bw(base_family = 'serif', base_size = 12) + 
    theme(
      strip.background = element_blank(), 
      axis.title.x = element_blank(), 
      legend.title = element_blank(),
      axis.text.x  = element_text(size = 10, angle = 45, hjust = 1),
      # panel.grid = element_blank(), 
      legend.position = 'top'
      ) +
    ylab(chm) + 
    scale_x_discrete(labels = format(unique(toplo2$date), '%Y-%m'))
  
  grid.arrange(p1, p2, ncol = 2)
  
}, height = 500, width = 900)
```

### Evaluating cumulative stress

Within each cohort year, the "cumulative stress" as the duration of time was estimated at which under-saturation of aragonite occcurred.  This was calculated two ways.  First, the number of times a sampling period was under-saturated was counted for all of the sampling months in a cohort-year.  This produced an estimate of total stress within a cohort-year as a count measure from zero to three, where zero meant that none of the sampling periods were under-saturated and three meant all were under-saturated.  Second, the number of times that July and September sampling events were under-saturated were counted as a measure of prior cumulative stress for the April sampling event.  This produced an estimate of cumulative stress as a count measure varying from zero to two.  For both cases, the amount of type 3 dissolution that was observed in April (i.e., mature adults at the end of a cohort-year) was used as a response to the cumulative stress measure.  

The analysis also considered what was defined as cumulative stress in addition to duration.  In other words, cumulative stress could be measured using the average aragonite saturation in a sampling month at a station, the minimum saturation, or the maximum saturation.  Additionally, what defines over- and under-saturation was also considered.  Typically, values less than one are considered undefr-saturated but this value could be changed as a measure of specificity to which individuals may show differential response.  The results below can be assessed in consideration of the above.  

```{r}
column(12, 
       
       column(4, selectInput('araval', 'Select aragonite value:', choices = c('min', 'ave', 'max'))),
       
       column(4, selectInput('strmsr', 'Select stress measure:', choices = list(total = 'totstr', cumulative = 'cumstr'))),
       
       column(4, numericInput('thrsh', 'Under-saturation threshold:', value = 1, min = 0, max = 5, step = 0.1))
       
       )
```

```{r}
strdat <- reactive({

  # inputs
  araval <- input$araval
  strmsr <- input$strmsr
  thrsh <- input$thrsh

  dat <- chmdat %>% 
    filter(var %in% 'ara') %>% 
    full_join(biodat, by = c('station', 'date', 'yr', 'cohortyr', 'mo')) %>% 
    select(-lon, -lat, -var, -abu, -avesz, -stdsz, -yr) %>% 
    gather('ara', 'val', ave:max) %>% 
    filter(ara %in% araval) %>% 
    mutate(aracat = ifelse(val < thrsh, 'under', 'over')) %>% 
    group_by(cohortyr, station) %>% 
    mutate(
      cumstr = sum(aracat[!mo %in% 'Apr'] %in% 'under'),
      totstr = sum(aracat %in% 'under')
      ) %>% 
    filter(mo %in% 'Apr') %>% 
    select(-aracat)

  names(dat)[names(dat) %in% strmsr] <- 'strsval'
  
  return(dat)
  
})

renderPlot({
  
  # input
  strdat <- strdat()
  
  ggplot(strdat, aes(x = factor(strsval), y = typ3)) +
    geom_boxplot() +
    scale_x_discrete('Cumulative stress magnitude') +
    scale_y_continuous('End of cohort-year (April) type 3') +
    theme_bw(base_family = 'serif', base_size = 18) +
    facet_wrap(~cohortyr, ncol = 2) 

}, height = 400, width = 750)
  
```

### Simulated data

Conditions at each station were simulated for 2008 at six hour time steps for every station.  Each time series was used to estimate the number of instances at which aragonite was under-saturated.  This measure of stress was then compared to the amount of type 3 dissolution during April for each cohort-year.  The stress measure can be varied by choosing the threshold for defining under-saturation and the number of days for defining a stress period.  For example, choosing a threshold of one and number of days as one will count the stress as the total number of days at which saturation was below one.  

```{r}
column(12, 
       
       column(4, numericInput('simthrsh', 'Under-saturation threshold:', value = 1, min = 0, max = 5, step = 0.1)),
       
       column(4, numericInput('runlen', 'Duration threshold (days):', value = 1, min = 1, max = 360, step = 1))
       
)
```

```{r}
strdatsim <- reactive({

  # input
  simthrsh <- input$simthrsh
  runlen <- input$runlen
  
  out <- simdat %>% 
    mutate(
      undercat = ifelse(ara < simthrsh, 'under', 'over')
    ) %>% 
    group_by(station) %>% 
    nest %>% 
    mutate(
      tots = purrr::map(data, function(x){
  
        # get runs
        runs <- rle(x$undercat)
  
        # get runs where undersaturated
        unders <- runs$lengths[runs$values == 'under']

        # divide by four becuase one day is four time steps
        dys <- floor(unders / (4 * runlen))
        
        # get total number of runs in period
        dys <- sum(dys)
        
        return(dys)
  
      })
    ) %>% 
    select(-data) %>%
    unnest
  
  return(out)
  
})
```

```{r}
renderPlot({
  
  # input
  simthrsh <- input$simthrsh
  runlen <- input$runlen
  strdatsim <- strdatsim()
  
  # y axis label
  ttl <- glue('Cumulative stress at under-saturation threshold of {simthrsh}\nCount as number of instances where under-saturated greater than {runlen} day(s)')
  
  ggplot(strdatsim, aes(x = factor(station), y = tots)) + 
    geom_bar(stat = 'identity') +
    theme_bw(base_family = 'serif', base_size = 16) +
    geom_text(aes(label = tots), vjust = 0, nudge_y = 4) +
    scale_x_discrete('Station') +
    scale_y_continuous('Stress count') + 
    ggtitle(ttl)

}, height = 400)

renderPlot({
  
  # input
  strdatsim <- strdatsim()
  
  # april type 3
  toplo <- biodat %>% 
    filter(mo %in% 'Apr') %>% 
    mutate(station = as.character(station)) %>% 
    left_join(strdatsim, by = 'station')
  
  ggplot(toplo, aes(x = tots, y = typ3)) + 
    # geom_point() + 
    geom_text(aes(label = station)) +
    facet_wrap(~cohortyr, ncol = 2) +
    theme_bw(base_family = 'serif', base_size = 16) +
    theme(
      strip.background = element_blank()
    ) + 
    stat_smooth(method = 'lm') +
    scale_y_continuous('April type 3 dissolution') +
    scale_x_continuous('Stress count')
  
}, height = 400)

renderPlot({
  
  # input
  simthrsh <- input$simthrsh
  
  blw <- simdat %>% 
    mutate(ara = ifelse(ara <= simthrsh, ara, NA))
  
  ggplot(simdat, aes(x = datetime, y = ara)) +
    geom_hline(yintercept = simthrsh, colour = 'grey') +
    geom_point(size = 0.5) +
    geom_point(data = blw, colour = 'red', size = 0.5) +
    scale_x_datetime(expand = c(0, 0), date_labels = '%m', date_breaks = '1 month') +
    facet_grid(station~.) +
    theme_bw(base_family = 'serif', base_size = 16) +
    theme(
      strip.background = element_blank(),
      axis.title.x = element_blank(),
      panel.grid = element_blank()
    )
}, height = 600)

```





